# This script expects source file as an archive file with name 'UCIData.zip'. If the file name is different, please modify the variable 'sourceZipFileName' to reflect the source archive file name.
sourceZipFileName <- 'UCIData.zip';
unzippedDirectoryName <- 'UCI HAR Dataset';

# unzip the archive file
unzip(sourceZipFileName);

# retrieve current working directory
currentWorkingDir <- getwd();

# moved working directory to unzipped folder
setwd(paste('./', unzippedDirectoryName, sep=""));

# load activity levels
activity_levels <- read.table('activity_labels.txt');

# load features data
features <- read.table('features.txt');
# find the row number of the features having 'mean','std' in its name
target_features <- grep('mean|std', features[, 2], ignore.case=T);
# filter only the above features
selectedFeatures <- as.vector(features[target_features,2]);

# read test data
subject_test <- read.table('./test/subject_test.txt', col.names = c('Subject_id'));
X_test <- read.table('./test/X_test.txt');
y_test <- read.table('./test/y_test.txt', col.names = c('Activity_Id'));

# merge test data
test_data <- cbind(X_test, subject_test, y_test);

# read training data
subject_train <- read.table('./train/subject_train.txt', col.names = c('Subject_id'));
X_train <- read.table('./train/X_train.txt');
y_train <- read.table('./train/y_train.txt', col.names = c('Activity_Id'));

#merge train data
train_data <- cbind(X_train, subject_train, y_train);

# combine test and train data
combined_data <- rbind(train_data, test_data);
number_of_columns <- ncol(combined_data);

# we need to retrieve the selected features columns, subject id, activity id
columnToBeSeclected <- c(target_features, number_of_columns - 1, number_of_columns);
combined_data <- combined_data[, columnToBeSeclected];

# join with activity levels
merged_data <- merge(combined_data, activity_levels, by.x = "Activity_Id", by.y = "V1");

# drop activity id column
merged_data <- merged_data[, -c(1)];

# apply meaningful names
names(merged_data) <- c('timeForBodyAccelerationMinusMeanAlongXAxis','timeForBodyAccelerationMinusMeanAlongYAxis','timeForBodyAccelerationMinusMeanAlongZAxis','timeForBodyAccelerationMinusStandardDeviationAlongXAxis','timeForBodyAccelerationMinusStandardDeviationAlongYAxis','timeForBodyAccelerationMinusStandardDeviationAlongZAxis','timeForGravityAccelerationMinusMeanAlongXAxis','timeForGravityAccelerationMinusMeanAlongYAxis','timeForGravityAccelerationMinusMeanAlongZAxis','timeForGravityAccelerationMinusStandardDeviationAlongXAxis','timeForGravityAccelerationMinusStandardDeviationAlongYAxis','timeForGravityAccelerationMinusStandardDeviationAlongZAxis','timeForBodyAccelerationJerkMinusMeanAlongXAxis','timeForBodyAccelerationJerkMinusMeanAlongYAxis','timeForBodyAccelerationJerkMinusMeanAlongZAxis','timeForBodyAccelerationJerkMinusStandardDeviationAlongXAxis','timeForBodyAccelerationJerkMinusStandardDeviationAlongYAxis','timeForBodyAccelerationJerkMinusStandardDeviationAlongZAxis','timeForBodyGyroMinusMeanAlongXAxis','timeForBodyGyroMinusMeanAlongYAxis','timeForBodyGyroMinusMeanAlongZAxis','timeForBodyGyroMinusStandardDeviationAlongXAxis','timeForBodyGyroMinusStandardDeviationAlongYAxis','timeForBodyGyroMinusStandardDeviationAlongZAxis','timeForBodyGyroJerkMinusMeanAlongXAxis','timeForBodyGyroJerkMinusMeanAlongYAxis','timeForBodyGyroJerkMinusMeanAlongZAxis','timeForBodyGyroJerkMinusStandardDeviationAlongXAxis','timeForBodyGyroJerkMinusStandardDeviationAlongYAxis','timeForBodyGyroJerkMinusStandardDeviationAlongZAxis','timeForBodyAccelerationMagMinusMean','timeForBodyAccelerationMagMinusStandardDeviation','timeForGravityAccelerationMagMinusMean','timeForGravityAccelerationMagMinusStandardDeviation','timeForBodyAccelerationJerkMagMinusMean','timeForBodyAccelerationJerkMagMinusStandardDeviation','timeForBodyGyroMagMinusMean','timeForBodyGyroMagMinusStandardDeviation','timeForBodyGyroJerkMagMinusMean','timeForBodyGyroJerkMagMinusStandardDeviation','frequencyOfBodyAccelerationMinusMeanAlongXAxis','frequencyOfBodyAccelerationMinusMeanAlongYAxis','frequencyOfBodyAccelerationMinusMeanAlongZAxis','frequencyOfBodyAccelerationMinusStandardDeviationAlongXAxis','frequencyOfBodyAccelerationMinusStandardDeviationAlongYAxis','frequencyOfBodyAccelerationMinusStandardDeviationAlongZAxis','frequencyOfBodyAccelerationMinusMeanFrequencyAlongXAxis','frequencyOfBodyAccelerationMinusMeanFrequencyAlongYAxis','frequencyOfBodyAccelerationMinusMeanFrequencyAlongZAxis','frequencyOfBodyAccelerationJerkMinusMeanAlongXAxis','frequencyOfBodyAccelerationJerkMinusMeanAlongYAxis','frequencyOfBodyAccelerationJerkMinusMeanAlongZAxis','frequencyOfBodyAccelerationJerkMinusStandardDeviationAlongXAxis','frequencyOfBodyAccelerationJerkMinusStandardDeviationAlongYAxis','frequencyOfBodyAccelerationJerkMinusStandardDeviationAlongZAxis','frequencyOfBodyAccelerationJerkMinusMeanFrequencyAlongXAxis','frequencyOfBodyAccelerationJerkMinusMeanFrequencyAlongYAxis','frequencyOfBodyAccelerationJerkMinusMeanFrequencyAlongZAxis','frequencyOfBodyGyroMinusMeanAlongXAxis','frequencyOfBodyGyroMinusMeanAlongYAxis','frequencyOfBodyGyroMinusMeanAlongZAxis','frequencyOfBodyGyroMinusStandardDeviationAlongXAxis','frequencyOfBodyGyroMinusStandardDeviationAlongYAxis','frequencyOfBodyGyroMinusStandardDeviationAlongZAxis','frequencyOfBodyGyroMinusMeanFrequencyAlongXAxis','frequencyOfBodyGyroMinusMeanFrequencyAlongYAxis','frequencyOfBodyGyroMinusMeanFrequencyAlongZAxis','frequencyOfBodyAccelerationMagMinusMean','frequencyOfBodyAccelerationMagMinusStandardDeviation','frequencyOfBodyAccelerationMagMinusMeanFrequency','frequencyOfBodyAccelerationJerkMagMinusMean','frequencyOfBodyAccelerationJerkMagMinusStandardDeviation','frequencyOfBodyAccelerationJerkMagMinusMeanFrequency','frequencyOfBodyGyroMagMinusMean','frequencyOfBodyGyroMagMinusStandardDeviation','frequencyOfBodyGyroMagMinusMeanFrequency','frequencyOfBodyGyroJerkMagMinusMean','frequencyOfBodyGyroJerkMagMinusStandardDeviation','frequencyOfBodyGyroJerkMagMinusMeanFrequency','angleBetweenTimeForBodyAccelerationMeanAndGravity','angleBetweenTimeForBodyAccelerationJerkMeanAndGravityMean','angleBetweenTimeForBodyGyroMeanAndGravityMean','angleBetweenTimeForBodyGyroJerkMeanAndGravityMean','angleBetweenXAxisAndGravityMean','angleBetweenYAxisAndGravityMean','angleBetweenZAxisAndGravityMean','subjectId','activity');

# load dplyr library
library(dplyr);

# group by activity, subjectId
groupped_data <- group_by(merged_data, activity, subjectId);

# retrieve tidy data by taking mean of each column
tidyData <- summarize(groupped_data, meanTimeForBodyAccelerationMinusMeanAlongXAxis = mean(timeForBodyAccelerationMinusMeanAlongXAxis),meanTimeForBodyAccelerationMinusMeanAlongYAxis = mean(timeForBodyAccelerationMinusMeanAlongYAxis),meanTimeForBodyAccelerationMinusMeanAlongZAxis = mean(timeForBodyAccelerationMinusMeanAlongZAxis),meanTimeForBodyAccelerationMinusStandardDeviationAlongXAxis = mean(timeForBodyAccelerationMinusStandardDeviationAlongXAxis),meanTimeForBodyAccelerationMinusStandardDeviationAlongYAxis = mean(timeForBodyAccelerationMinusStandardDeviationAlongYAxis),meanTimeForBodyAccelerationMinusStandardDeviationAlongZAxis = mean(timeForBodyAccelerationMinusStandardDeviationAlongZAxis),meanTimeForGravityAccelerationMinusMeanAlongXAxis = mean(timeForGravityAccelerationMinusMeanAlongXAxis),meanTimeForGravityAccelerationMinusMeanAlongYAxis = mean(timeForGravityAccelerationMinusMeanAlongYAxis),meanTimeForGravityAccelerationMinusMeanAlongZAxis = mean(timeForGravityAccelerationMinusMeanAlongZAxis),meanTimeForGravityAccelerationMinusStandardDeviationAlongXAxis = mean(timeForGravityAccelerationMinusStandardDeviationAlongXAxis),meanTimeForGravityAccelerationMinusStandardDeviationAlongYAxis = mean(timeForGravityAccelerationMinusStandardDeviationAlongYAxis),meanTimeForGravityAccelerationMinusStandardDeviationAlongZAxis = mean(timeForGravityAccelerationMinusStandardDeviationAlongZAxis),meanTimeForBodyAccelerationJerkMinusMeanAlongXAxis = mean(timeForBodyAccelerationJerkMinusMeanAlongXAxis),meanTimeForBodyAccelerationJerkMinusMeanAlongYAxis = mean(timeForBodyAccelerationJerkMinusMeanAlongYAxis),meanTimeForBodyAccelerationJerkMinusMeanAlongZAxis = mean(timeForBodyAccelerationJerkMinusMeanAlongZAxis),meanTimeForBodyAccelerationJerkMinusStandardDeviationAlongXAxis = mean(timeForBodyAccelerationJerkMinusStandardDeviationAlongXAxis),meanTimeForBodyAccelerationJerkMinusStandardDeviationAlongYAxis = mean(timeForBodyAccelerationJerkMinusStandardDeviationAlongYAxis),meanTimeForBodyAccelerationJerkMinusStandardDeviationAlongZAxis = mean(timeForBodyAccelerationJerkMinusStandardDeviationAlongZAxis),meanTimeForBodyGyroMinusMeanAlongXAxis = mean(timeForBodyGyroMinusMeanAlongXAxis),meanTimeForBodyGyroMinusMeanAlongYAxis = mean(timeForBodyGyroMinusMeanAlongYAxis),meanTimeForBodyGyroMinusMeanAlongZAxis = mean(timeForBodyGyroMinusMeanAlongZAxis),meanTimeForBodyGyroMinusStandardDeviationAlongXAxis = mean(timeForBodyGyroMinusStandardDeviationAlongXAxis),meanTimeForBodyGyroMinusStandardDeviationAlongYAxis = mean(timeForBodyGyroMinusStandardDeviationAlongYAxis),meanTimeForBodyGyroMinusStandardDeviationAlongZAxis = mean(timeForBodyGyroMinusStandardDeviationAlongZAxis),meanTimeForBodyGyroJerkMinusMeanAlongXAxis = mean(timeForBodyGyroJerkMinusMeanAlongXAxis),meanTimeForBodyGyroJerkMinusMeanAlongYAxis = mean(timeForBodyGyroJerkMinusMeanAlongYAxis),meanTimeForBodyGyroJerkMinusMeanAlongZAxis = mean(timeForBodyGyroJerkMinusMeanAlongZAxis),meanTimeForBodyGyroJerkMinusStandardDeviationAlongXAxis = mean(timeForBodyGyroJerkMinusStandardDeviationAlongXAxis),meanTimeForBodyGyroJerkMinusStandardDeviationAlongYAxis = mean(timeForBodyGyroJerkMinusStandardDeviationAlongYAxis),meanTimeForBodyGyroJerkMinusStandardDeviationAlongZAxis = mean(timeForBodyGyroJerkMinusStandardDeviationAlongZAxis),meanTimeForBodyAccelerationMagMinusMean = mean(timeForBodyAccelerationMagMinusMean),meanTimeForBodyAccelerationMagMinusStandardDeviation = mean(timeForBodyAccelerationMagMinusStandardDeviation),meanTimeForGravityAccelerationMagMinusMean = mean(timeForGravityAccelerationMagMinusMean),meanTimeForGravityAccelerationMagMinusStandardDeviation = mean(timeForGravityAccelerationMagMinusStandardDeviation),meanTimeForBodyAccelerationJerkMagMinusMean = mean(timeForBodyAccelerationJerkMagMinusMean),meanTimeForBodyAccelerationJerkMagMinusStandardDeviation = mean(timeForBodyAccelerationJerkMagMinusStandardDeviation),meanTimeForBodyGyroMagMinusMean = mean(timeForBodyGyroMagMinusMean),meanTimeForBodyGyroMagMinusStandardDeviation = mean(timeForBodyGyroMagMinusStandardDeviation),meanTimeForBodyGyroJerkMagMinusMean = mean(timeForBodyGyroJerkMagMinusMean),meanTimeForBodyGyroJerkMagMinusStandardDeviation = mean(timeForBodyGyroJerkMagMinusStandardDeviation),meanFrequencyOfBodyAccelerationMinusMeanAlongXAxis = mean(frequencyOfBodyAccelerationMinusMeanAlongXAxis),meanFrequencyOfBodyAccelerationMinusMeanAlongYAxis = mean(frequencyOfBodyAccelerationMinusMeanAlongYAxis),meanFrequencyOfBodyAccelerationMinusMeanAlongZAxis = mean(frequencyOfBodyAccelerationMinusMeanAlongZAxis),meanFrequencyOfBodyAccelerationMinusStandardDeviationAlongXAxis = mean(frequencyOfBodyAccelerationMinusStandardDeviationAlongXAxis),meanFrequencyOfBodyAccelerationMinusStandardDeviationAlongYAxis = mean(frequencyOfBodyAccelerationMinusStandardDeviationAlongYAxis),meanFrequencyOfBodyAccelerationMinusStandardDeviationAlongZAxis = mean(frequencyOfBodyAccelerationMinusStandardDeviationAlongZAxis),meanFrequencyOfBodyAccelerationMinusMeanFrequencyAlongXAxis = mean(frequencyOfBodyAccelerationMinusMeanFrequencyAlongXAxis),meanFrequencyOfBodyAccelerationMinusMeanFrequencyAlongYAxis = mean(frequencyOfBodyAccelerationMinusMeanFrequencyAlongYAxis),meanFrequencyOfBodyAccelerationMinusMeanFrequencyAlongZAxis = mean(frequencyOfBodyAccelerationMinusMeanFrequencyAlongZAxis),meanFrequencyOfBodyAccelerationJerkMinusMeanAlongXAxis = mean(frequencyOfBodyAccelerationJerkMinusMeanAlongXAxis),meanFrequencyOfBodyAccelerationJerkMinusMeanAlongYAxis = mean(frequencyOfBodyAccelerationJerkMinusMeanAlongYAxis),meanFrequencyOfBodyAccelerationJerkMinusMeanAlongZAxis = mean(frequencyOfBodyAccelerationJerkMinusMeanAlongZAxis),meanFrequencyOfBodyAccelerationJerkMinusStandardDeviationAlongXAxis = mean(frequencyOfBodyAccelerationJerkMinusStandardDeviationAlongXAxis),meanFrequencyOfBodyAccelerationJerkMinusStandardDeviationAlongYAxis = mean(frequencyOfBodyAccelerationJerkMinusStandardDeviationAlongYAxis),meanFrequencyOfBodyAccelerationJerkMinusStandardDeviationAlongZAxis = mean(frequencyOfBodyAccelerationJerkMinusStandardDeviationAlongZAxis),meanFrequencyOfBodyAccelerationJerkMinusMeanFrequencyAlongXAxis = mean(frequencyOfBodyAccelerationJerkMinusMeanFrequencyAlongXAxis),meanFrequencyOfBodyAccelerationJerkMinusMeanFrequencyAlongYAxis = mean(frequencyOfBodyAccelerationJerkMinusMeanFrequencyAlongYAxis),meanFrequencyOfBodyAccelerationJerkMinusMeanFrequencyAlongZAxis = mean(frequencyOfBodyAccelerationJerkMinusMeanFrequencyAlongZAxis),meanFrequencyOfBodyGyroMinusMeanAlongXAxis = mean(frequencyOfBodyGyroMinusMeanAlongXAxis),meanFrequencyOfBodyGyroMinusMeanAlongYAxis = mean(frequencyOfBodyGyroMinusMeanAlongYAxis),meanFrequencyOfBodyGyroMinusMeanAlongZAxis = mean(frequencyOfBodyGyroMinusMeanAlongZAxis),meanFrequencyOfBodyGyroMinusStandardDeviationAlongXAxis = mean(frequencyOfBodyGyroMinusStandardDeviationAlongXAxis),meanFrequencyOfBodyGyroMinusStandardDeviationAlongYAxis = mean(frequencyOfBodyGyroMinusStandardDeviationAlongYAxis),meanFrequencyOfBodyGyroMinusStandardDeviationAlongZAxis = mean(frequencyOfBodyGyroMinusStandardDeviationAlongZAxis),meanFrequencyOfBodyGyroMinusMeanFrequencyAlongXAxis = mean(frequencyOfBodyGyroMinusMeanFrequencyAlongXAxis),meanFrequencyOfBodyGyroMinusMeanFrequencyAlongYAxis = mean(frequencyOfBodyGyroMinusMeanFrequencyAlongYAxis),meanFrequencyOfBodyGyroMinusMeanFrequencyAlongZAxis = mean(frequencyOfBodyGyroMinusMeanFrequencyAlongZAxis),meanFrequencyOfBodyAccelerationMagMinusMean = mean(frequencyOfBodyAccelerationMagMinusMean),meanFrequencyOfBodyAccelerationMagMinusStandardDeviation = mean(frequencyOfBodyAccelerationMagMinusStandardDeviation),meanFrequencyOfBodyAccelerationMagMinusMeanFrequency = mean(frequencyOfBodyAccelerationMagMinusMeanFrequency),meanFrequencyOfBodyAccelerationJerkMagMinusMean = mean(frequencyOfBodyAccelerationJerkMagMinusMean),meanFrequencyOfBodyAccelerationJerkMagMinusStandardDeviation = mean(frequencyOfBodyAccelerationJerkMagMinusStandardDeviation),meanFrequencyOfBodyAccelerationJerkMagMinusMeanFrequency = mean(frequencyOfBodyAccelerationJerkMagMinusMeanFrequency),meanFrequencyOfBodyGyroMagMinusMean = mean(frequencyOfBodyGyroMagMinusMean),meanFrequencyOfBodyGyroMagMinusStandardDeviation = mean(frequencyOfBodyGyroMagMinusStandardDeviation),meanFrequencyOfBodyGyroMagMinusMeanFrequency = mean(frequencyOfBodyGyroMagMinusMeanFrequency),meanFrequencyOfBodyGyroJerkMagMinusMean = mean(frequencyOfBodyGyroJerkMagMinusMean),meanFrequencyOfBodyGyroJerkMagMinusStandardDeviation = mean(frequencyOfBodyGyroJerkMagMinusStandardDeviation),meanFrequencyOfBodyGyroJerkMagMinusMeanFrequency = mean(frequencyOfBodyGyroJerkMagMinusMeanFrequency),meanAngleBetweenTimeForBodyAccelerationMeanAndGravity = mean(angleBetweenTimeForBodyAccelerationMeanAndGravity),meanAngleBetweenTimeForBodyAccelerationJerkMeanAndGravityMean = mean(angleBetweenTimeForBodyAccelerationJerkMeanAndGravityMean)
,meanAngleBetweenTimeForBodyGyroMeanAndGravityMean = mean(angleBetweenTimeForBodyGyroMeanAndGravityMean),meanAngleBetweenTimeForBodyGyroJerkMeanAndGravityMean = mean(angleBetweenTimeForBodyGyroJerkMeanAndGravityMean),meanAngleBetweenXAxisAndGravityMean = mean(angleBetweenXAxisAndGravityMean),meanAngleBetweenYAxisAndGravityMean = mean(angleBetweenYAxisAndGravityMean),meanAngleBetweenZAxisAndGravityMean = mean(angleBetweenZAxisAndGravityMean)
);

# switch back to starting directory
setwd(currentWorkingDir);

# delete the 
unlink(unzippedDirectoryName, recursive = TRUE);

# removing temporary objects
rm(currentWorkingDir, sourceZipFileName, unzippedDirectoryName, activity_levels, features, target_features, selectedFeatures, subject_test, X_test, y_test, test_data, subject_train, X_train, y_train, train_data, combined_data, groupped_data, merged_data);
